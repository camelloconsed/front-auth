image: docker:latest

variables:
    IMAGE_NAME: survey-auth-consumer
    DOCKER_TAG: latest
    REGISTRY_URL: 711021018325.dkr.ecr.us-west-2.amazonaws.com
    DOCKER_IMAGE: $REGISTRY_URL/$IMAGE_NAME:$DOCKER_TAG

stages:
    - build

before_script:
    - echo $DOCKER_IMAGE
    - apk update
    - apk add --no-cache py-pip
    - pip install -U setuptools
    - apk add python-dev libffi-dev openssl-dev gcc libc-dev make
    - pip install --upgrade pip
    - pip install docker-compose
    - docker-compose --version
    - pip install awscli
    - aws --version
    - $(aws ecr get-login --no-include-email --region $AWS_REGION)

build:
    stage: build
    services:
        - docker:dind
    script:
        - echo "Building"
        - docker-compose -f ./docker/docker-compose.yml build --pull --no-cache
        - docker push $DOCKER_IMAGE
